name: Sync GitHub Commits to Notion

on:
  push:
    branches:
      - main
      - master

jobs:
  sync-to-notion:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 2
      
      - name: Get commit info
        id: commit
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B | head -n 1)
          COMMIT_MSG="${COMMIT_MSG//\"/\\\"}"
          COMMIT_MSG="${COMMIT_MSG//\'/\\\'}"
          COMMIT_SHA=$(git log -1 --pretty=%H)
          COMMIT_DATE=$(git log -1 --pretty=%cI)

          echo "message=$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "date=$COMMIT_DATE" >> $GITHUB_OUTPUT
      
      - name: Send to Notion
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
          COMMIT_MESSAGE: ${{ steps.commit.outputs.message }}
          COMMIT_SHA: ${{ steps.commit.outputs.sha }}
          COMMIT_DATE: ${{ steps.commit.outputs.date }}
          REPO_URL: ${{ github.repository }}
        run: |
          COMMIT_URL="https://github.com/${REPO_URL}/commit/${COMMIT_SHA}"
          
          curl -X POST https://api.notion.com/v1/pages \
            -H "Authorization: Bearer ${NOTION_TOKEN}" \
            -H "Content-Type: application/json" \
            -H "Notion-Version: 2022-06-28" \
            --data-binary @- <<EOF
          {
            "parent": { "database_id": "${NOTION_DATABASE_ID}" },
            "properties": {
              "이름": {
                "title": [
                  {
                    "text": {
                      "content": "${COMMIT_MESSAGE}",
                      "link": {
                        "url": "${COMMIT_URL}"
                      }
                    }
                  }
                ]
              },
              "날짜": {
                "date": {
                  "start": "${COMMIT_DATE}"
                }
              }
            }
          }
          EOF
