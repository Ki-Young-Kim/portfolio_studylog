name: Sync GitHub Commits to Notion

on:
  push:
    branches:
      - main
      - master

jobs:
  sync-to-notion:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 2
      
      - name: Get commit info
        id: commit
        run: |
          echo "message=$(git log -1 --pretty=%B | head -n 1)" >> $GITHUB_OUTPUT
          echo "author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT
          echo "sha=$(git log -1 --pretty=%h)" >> $GITHUB_OUTPUT
          echo "date=$(git log -1 --pretty=%ci)" >> $GITHUB_OUTPUT
      
      - name: Send to Notion
        env:
          NOTION_TOKEN: $ secrets.NOTION_TOKEN 
          NOTION_DATABASE_ID: $ secrets.NOTION_DATABASE_ID 
        run: |
          curl -X POST https://api.notion.com/v1/pages \
            -H "Authorization: Bearer $NOTION_TOKEN" \
            -H "Content-Type: application/json" \
            -H "Notion-Version: 2022-06-28" \
            --data '{
              "parent": { "database_id": "'$NOTION_DATABASE_ID'" },
              "properties": {
                "Name": {
                  "title": [
                    {
                      "text": {
                        "content": "'"$ steps.commit.outputs.message "'"
                      }
                    }
                  ]
                }
              }
            }'
